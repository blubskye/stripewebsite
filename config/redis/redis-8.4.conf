# Redis 8.4+ Optimized Configuration
# https://redis.io/docs/latest/operate/oss_and_stack/stack-with-enterprise/release-notes/redisce/redisos-8.4-release-notes/
#
# This configuration enables Redis 8's async I/O threading and other
# performance optimizations for multi-core systems.

# ==== NETWORKING ====
bind 127.0.0.1
port 6379
protected-mode yes
tcp-backlog 511
timeout 0
tcp-keepalive 300

# ==== ASYNC I/O THREADING (Redis 8+) ====
# Enable async I/O threads for multi-core performance.
# Recommended: Set to number of CPU cores (up to 8).
# Performance: 37-112% throughput improvement on 8 cores.
io-threads 8

# Enable threaded reads (requires io-threads > 1)
io-threads-do-reads yes

# ==== LOOKAHEAD PREFETCHING (Redis 8.4+) ====
# Parse multiple commands in advance for better pipelining.
# Default: 16, higher values use more memory but may improve throughput.
# lookahead 16

# ==== MEMORY MANAGEMENT ====
maxmemory 256mb
maxmemory-policy allkeys-lru

# LFU tuning for better cache efficiency
lfu-log-factor 10
lfu-decay-time 1

# ==== PERSISTENCE ====
# RDB snapshots
save 900 1
save 300 10
save 60 10000

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb

# AOF for durability (optional, adds latency)
appendonly no

# ==== LOGGING ====
loglevel notice
logfile ""

# ==== DATABASES ====
databases 16

# ==== SLOW LOG ====
slowlog-log-slower-than 10000
slowlog-max-len 128

# ==== LATENCY MONITORING ====
latency-monitor-threshold 0

# ==== CLIENTS ====
maxclients 10000

# ==== SECURITY ====
# Uncomment and set a strong password in production
# requirepass your_strong_password_here

# ==== PERFORMANCE TUNING ====
# Lazy freeing for async deletion (reduces blocking)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Active defragmentation
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 1
active-defrag-cycle-max 25

# ==== NOTES ====
# 1. For production, always set requirepass
# 2. Adjust io-threads based on your CPU cores (4-8 recommended)
# 3. Monitor with: redis-cli info stats | grep io_threads
# 4. This config is shared by both nsfwdiscordme and stripewebsite
